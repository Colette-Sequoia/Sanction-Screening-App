<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Sanction Screening</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #05263B;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .upload-card {
            border: 2px dashed #cbd5e1;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        
        .upload-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .upload-card.active {
            border-color: #667eea;
            background: #e0e7ff;
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .upload-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #05263B;
            margin-bottom: 10px;
        }
        
        .upload-subtitle {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .browse-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .browse-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .threshold-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 15px;
        }
        
        .threshold-label {
            font-weight: 600;
            color: #05263B;
            min-width: 120px;
        }
        
        .threshold-slider {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        .threshold-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
        }
        
        .threshold-value {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .process-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .process-btn.processing {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #05263B;
        }
        
        .download-btn {
            background: #05263B;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .download-btn:hover:not(:disabled) {
            background: #1e293b;
            transform: translateY(-1px);
        }
        
        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .results-content {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: #05263B;
            border: 1px solid #e2e8f0;
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .upload-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .threshold-container {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .threshold-label {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Sanction Screening</h1>
            <div class="subtitle">Advanced Name Matching System</div>
        </div>
        
        <div class="upload-section">
            <div class="upload-card" id="referenceCard">
                <div class="upload-icon">üìã</div>
                <div class="upload-title">Reference Data</div>
                <div class="upload-subtitle">Upload UN_List or reference file</div>
                <input type="file" id="referenceFile" class="file-input" accept=".xlsx,.xls,.csv">
                <button class="browse-btn" onclick="document.getElementById('referenceFile').click()">
                    üìÅ Browse Files
                </button>
                <div id="referenceStatus" style="margin-top: 15px; font-weight: 600; color: #05263B;"></div>
            </div>
            
            <div class="upload-card" id="clientCard">
                <div class="upload-icon">üë•</div>
                <div class="upload-title">Client Data</div>
                <div class="upload-subtitle">Upload client file to screen</div>
                <input type="file" id="clientFile" class="file-input" accept=".xlsx,.xls,.csv">
                <button class="browse-btn" onclick="document.getElementById('clientFile').click()">
                    üìÅ Browse Files
                </button>
                <div id="clientStatus" style="margin-top: 15px; font-weight: 600; color: #05263B;"></div>
            </div>
        </div>
        
        <div class="threshold-container">
            <div class="threshold-label">Match Threshold:</div>
            <input type="range" id="thresholdSlider" class="threshold-slider" min="50" max="100" value="80">
            <div class="threshold-value" id="thresholdValue">80%</div>
        </div>
        
        <button id="processBtn" class="process-btn" onclick="processFiles()">
            üöÄ Start Screening
        </button>
        
        <div id="statusMessage"></div>
        
        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-title">üìä Screening Results</div>
                <button id="downloadBtn" class="download-btn" onclick="downloadResults()" disabled>
                    üíæ Download Results
                </button>
            </div>
            <div class="results-content" id="resultsContent"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let unListData = [];
        let fileData = [];
        let processingResults = null;
        
        // Initialize threshold slider
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValue = document.getElementById('thresholdValue');
        
        thresholdSlider.addEventListener('input', function() {
            thresholdValue.textContent = this.value + '%';
        });
        
        // File upload handlers
        document.getElementById('referenceFile').addEventListener('change', function(e) {
            readExcelFile(e.target.files[0], 'reference');
        });
        
        document.getElementById('clientFile').addEventListener('change', function(e) {
            readExcelFile(e.target.files[0], 'client');
        });
        
        // Read Excel file
        function readExcelFile(file, fileType) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (fileType === 'reference') {
                        unListData = jsonData;
                        document.getElementById('referenceStatus').textContent = `‚úÖ Reference data loaded (${jsonData.length} records)`;
                        document.getElementById('referenceCard').classList.add('active');
                    } else {
                        fileData = jsonData;
                        document.getElementById('clientStatus').textContent = `‚úÖ Client data loaded (${jsonData.length} records)`;
                        document.getElementById('clientCard').classList.add('active');
                    }
                    
                    checkReadyToProcess();
                } catch (error) {
                    showStatus('‚ùå Error reading file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Check if ready to process
        function checkReadyToProcess() {
            const processBtn = document.getElementById('processBtn');
            if (unListData.length > 0 && fileData.length > 0) {
                processBtn.disabled = false;
                processBtn.textContent = 'üöÄ Start Screening';
            } else {
                processBtn.disabled = true;
                processBtn.textContent = 'üìÅ Please upload both files';
            }
        }
        
        // Process files
        function processFiles() {
            if (unListData.length === 0 || fileData.length === 0) {
                showStatus('‚ùå Please upload both reference and client files', 'error');
                return;
            }
            
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.classList.add('processing');
            processBtn.textContent = '‚è≥ Processing...';
            
            showStatus('üîÑ Processing files...', 'info');
            
            // Use setTimeout to allow UI to update
            setTimeout(() => {
                try {
                    const results = performMatching();
                    displayResults(results);
                    showStatus('‚úÖ Processing completed successfully!', 'success');
                } catch (error) {
                    showStatus('‚ùå Error during processing: ' + error.message, 'error');
                } finally {
                    processBtn.disabled = false;
                    processBtn.classList.remove('processing');
                    processBtn.textContent = 'üöÄ Start Screening';
                }
            }, 100);
        }
        
        // Perform matching (exact same logic as Python app)
        function performMatching() {
            const threshold = parseInt(thresholdSlider.value);
            const highMatches = [];
            const partialMatches = [];
            
            // Use exact column names like Python app
            const unNameCol = 'FullName';
            const fileNameCol = 'Client Name and Surname';
            
            // Normalize names function (exact same as Python)
            function normalizeName(name) {
                if (!name) return "";
                
                let nameStr = String(name).trim().toLowerCase();
                
                // Remove common titles ONLY from the beginning (with and without periods)
                const titles = ['mr ', 'mrs ', 'ms ', 'dr ', 'prof ', 'sir ', 'madam ', 'miss ', 'mx ', 
                               'mr. ', 'mrs. ', 'ms. ', 'dr. ', 'prof. ', 'sir. ', 'madam. ', 'miss. ', 'mx. '];
                for (const title of titles) {
                    if (nameStr.startsWith(title)) {
                        nameStr = nameStr.substring(title.length);
                        break;
                    }
                }
                
                // Remove special characters and normalize whitespace
                nameStr = nameStr.replace(/[^\w\s]/g, '');
                nameStr = nameStr.replace(/\s+/g, ' ').trim();
                
                return nameStr;
            }
            
            // Calculate similarity (exact same as Python)
            function calculateSimilarity(name1, name2) {
                const norm1 = normalizeName(name1);
                const norm2 = normalizeName(name2);
                
                if (!norm1 || !norm2) return 0;
                
                // Levenshtein distance
                const longer = norm1.length > norm2.length ? norm1 : norm2;
                const shorter = norm1.length > norm2.length ? norm2 : norm1;
                
                if (longer.length === 0) return 100.0;
                
                const distance = levenshteinDistance(longer, shorter);
                return ((longer.length - distance) / longer.length) * 100;
            }
            
            // Levenshtein distance implementation
            function levenshteinDistance(str1, str2) {
                const matrix = [];
                
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }
            
            // Perform matching (exact same logic as Python)
            fileData.forEach(fileRow => {
                const fileName = String(fileRow[fileNameCol] || '').trim();
                if (!fileName) return;
                
                let bestMatch = null;
                let bestScore = 0;
                
                unListData.forEach(unRow => {
                    const unName = String(unRow[unNameCol] || '').trim();
                    if (!unName) return;
                    
                    const score = calculateSimilarity(fileName, unName);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = { unName, score, unRow };
                    }
                });
                
                if (bestMatch) {
                    if (bestScore >= threshold) {
                        highMatches.push({
                            fileName,
                            unName: bestMatch.unName,
                            score: bestScore.toFixed(1),
                            fileRow,
                            unRow: bestMatch.unRow
                        });
                    } else if (bestScore >= 50) {
                        partialMatches.push({
                            fileName,
                            unName: bestMatch.unName,
                            score: bestScore.toFixed(1),
                            fileRow,
                            unRow: bestMatch.unRow
                        });
                    }
                }
            });
            
            // Generate results text (exact same format as Python)
            let resultsText = `üéØ High Matches (‚â•${threshold}%): ${highMatches.length}\n`;
            resultsText += `üîç Partial Matches (<${threshold}%): ${partialMatches.length}\n`;
            resultsText += `üìã Total UN_List records: ${unListData.length}\n`;
            resultsText += `üìã Total file records: ${fileData.length}\n\n`;
            resultsText += `============================================================\n`;
            resultsText += `‚úÖ Processing completed successfully!\n\n`;
            
            if (highMatches.length > 0) {
                resultsText += `ü§ù HIGH CONFIDENCE MATCHES:\n`;
                resultsText += `--------------------------------------------------\n`;
                highMatches.slice(0, 15).forEach((match, index) => {
                    resultsText += `${index + 1}. ${match.fileName} ‚Üî ${match.unName} (Score: ${match.score}%)\n`;
                });
                if (highMatches.length > 15) {
                    resultsText += `... and ${highMatches.length - 15} more high matches\n`;
                }
                resultsText += `\n`;
            }
            
            if (partialMatches.length > 0) {
                resultsText += `üîç PARTIAL MATCHES (Below ${threshold}% threshold):\n`;
                resultsText += `--------------------------------------------------\n`;
                partialMatches.slice(0, 8).forEach((match, index) => {
                    resultsText += `${index + 1}. ${match.fileName} ‚Üî ${match.unName} (Score: ${match.score}%)\n`;
                });
                if (partialMatches.length > 8) {
                    resultsText += `... and ${partialMatches.length - 8} more partial matches\n`;
                }
                resultsText += `\n`;
            }
            
            resultsText += `============================================================`;
            
            return {
                text: resultsText,
                data: { highMatches, partialMatches }
            };
        }
        
        // Display results
        function displayResults(results) {
            processingResults = results;
            document.getElementById('resultsContent').textContent = results.text;
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('downloadBtn').disabled = false;
        }
        
        // Download results
        function downloadResults() {
            if (!processingResults) {
                showStatus('‚ùå No results to download', 'error');
                return;
            }
            
            // Create CSV content
            let csvContent = 'Type,File Name,UN List Name,Score (%)\n';
            
            processingResults.data.highMatches.forEach(match => {
                csvContent += `High Match,"${match.fileName}","${match.unName}",${match.score}\n`;
            });
            
            processingResults.data.partialMatches.forEach(match => {
                csvContent += `Partial Match,"${match.fileName}","${match.unName}",${match.score}\n`;
            });
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sanction_screening_results_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showStatus('‚úÖ Results downloaded successfully!', 'success');
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Initialize
        checkReadyToProcess();
    </script>
</body>
</html>
