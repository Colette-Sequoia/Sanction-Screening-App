<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanction Screening App - Real Processing</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #05263B;
            color: white;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            background: #05263B;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .header {
            background: #05263B;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #073855;
            position: relative;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }
        
        .logo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 140px;
            height: 40px;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #05263B;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .card {
            background: #073855;
            border: 2px solid #05263B;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: white;
        }
        
        .file-upload {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .file-label {
            background: #05263B;
            padding: 8px 15px;
            border-radius: 6px;
            flex: 1;
            text-align: center;
        }
        
        .browse-btn {
            background: white;
            color: #05263B;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .browse-btn:hover {
            background: #f0f0f0;
        }
        
        .threshold-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .threshold-slider {
            flex: 1;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .threshold-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .threshold-value {
            background: white;
            color: #05263B;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }
        
        .compare-btn {
            background: white;
            color: #05263B;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .compare-btn:hover {
            background: #f0f0f0;
        }
        
        .compare-btn:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-text {
            text-align: center;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .download-btn {
            background: white;
            color: #05263B;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px auto;
            display: block;
        }
        
        .download-btn:hover {
            background: #f0f0f0;
        }
        
        .download-btn:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }
        
        .results-area {
            background: white;
            color: #05263B;
            border: 2px solid #05263B;
            border-radius: 6px;
            padding: 15px;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .warning {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="logo">LOGO</div>
            <div class="app-title">üîç Sanction Screening - Real Processing</div>
        </div>
        
        <div class="main-content">
            <!-- UN List Upload -->
            <div class="card">
                <div class="card-title">üìã Upload UN_List Reference Data</div>
                <div class="warning">‚ö†Ô∏è Please upload your UN_List.xlsx file for real processing</div>
                <div class="file-upload">
                    <div class="file-label" id="unListLabel">No UN_List file selected</div>
                    <button class="browse-btn" onclick="selectUNList()">Browse</button>
                </div>
                <input type="file" id="unListInput" style="display: none;" accept=".xlsx,.xls,.csv">
                <div id="unListStatus" style="margin-top: 10px; font-size: 12px;"></div>
            </div>
            
            <!-- File Upload -->
            <div class="card">
                <div class="card-title">üìÅ Select File to Match</div>
                <div class="file-upload">
                    <div class="file-label" id="fileLabel">No file selected</div>
                    <button class="browse-btn" onclick="selectFile()">Browse</button>
                </div>
                <input type="file" id="fileInput" style="display: none;" accept=".xlsx,.xls,.csv">
            </div>
            
            <!-- Settings -->
            <div class="card">
                <div class="card-title">‚öôÔ∏è Settings</div>
                <div class="threshold-container">
                    <span>üéØ Match Threshold:</span>
                    <input type="range" class="threshold-slider" id="thresholdSlider" min="50" max="100" value="80">
                    <div class="threshold-value" id="thresholdValue">80%</div>
                </div>
            </div>
            
            <!-- Process Button -->
            <button class="compare-btn" id="compareBtn" onclick="processFiles()" disabled>üöÄ Compare Names</button>
            
            <!-- Progress -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status-text" id="statusText">Ready to process files</div>
            
            <!-- Download Button -->
            <button class="download-btn" id="downloadBtn" onclick="downloadResults()" disabled>üíæ Download Results</button>
            
            <!-- Results -->
            <div class="card">
                <div class="card-title">üìä Results</div>
                <div class="results-area" id="resultsArea">
                    Results will appear here after processing...
                </div>
            </div>
        </div>
    </div>

    <script>
        let unListData = null;
        let fileData = null;
        let processingResults = null;
        
        // UN List selection
        function selectUNList() {
            document.getElementById('unListInput').click();
        }
        
        document.getElementById('unListInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('unListLabel').textContent = file.name;
                readExcelFile(file, 'unList');
            }
        });
        
        // File selection
        function selectFile() {
            document.getElementById('fileInput').click();
        }
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileLabel').textContent = file.name;
                readExcelFile(file, 'file');
            }
        });
        
        // Read Excel file
        function readExcelFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (type === 'unList') {
                        unListData = jsonData;
                        document.getElementById('unListStatus').textContent = `‚úÖ UN_List loaded: ${jsonData.length} records`;
                        checkReadyState();
                    } else {
                        fileData = jsonData;
                        checkReadyState();
                    }
                } catch (error) {
                    console.error('Error reading file:', error);
                    alert('Error reading file. Please ensure it\'s a valid Excel file.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Check if ready to process
        function checkReadyState() {
            const compareBtn = document.getElementById('compareBtn');
            if (unListData && fileData) {
                compareBtn.disabled = false;
                document.getElementById('statusText').textContent = 'Ready to process files';
            }
        }
        
        // Threshold slider
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdValue = document.getElementById('thresholdValue');
        
        thresholdSlider.addEventListener('input', function() {
            thresholdValue.textContent = this.value + '%';
        });
        
        // Normalize name function (JavaScript version of Python logic)
        function normalizeName(name) {
            if (!name) return "";
            
            let nameStr = String(name).trim().toLowerCase();
            
            // Remove common titles
            const titles = ['mr', 'mrs', 'ms', 'dr', 'prof', 'sir', 'madam', 'miss', 'mx'];
            const words = nameStr.split(' ');
            const filteredWords = words.filter(word => !titles.includes(word));
            nameStr = filteredWords.join(' ');
            
            // Remove special characters and normalize whitespace
            nameStr = nameStr.replace(/[^\w\s]/g, '');
            nameStr = nameStr.replace(/\s+/g, ' ').trim();
            
            return nameStr;
        }
        
        // Calculate similarity (simplified fuzzy matching)
        function calculateSimilarity(name1, name2) {
            const norm1 = normalizeName(name1);
            const norm2 = normalizeName(name2);
            
            if (!norm1 || !norm2) return 0;
            
            // Simple Levenshtein distance approximation
            const longer = norm1.length > norm2.length ? norm1 : norm2;
            const shorter = norm1.length > norm2.length ? norm2 : norm1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return ((longer.length - distance) / longer.length) * 100;
        }
        
        // Levenshtein distance
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // Process files
        function processFiles() {
            if (!unListData || !fileData) {
                alert('Please upload both UN_List and file to match');
                return;
            }
            
            const compareBtn = document.getElementById('compareBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const progressFill = document.getElementById('progressFill');
            const statusText = document.getElementById('statusText');
            const resultsArea = document.getElementById('resultsArea');
            
            compareBtn.disabled = true;
            downloadBtn.disabled = true;
            statusText.textContent = 'Processing files...';
            resultsArea.textContent = '';
            
            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                progressFill.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    
                    // Perform real matching
                    const results = performRealMatching();
                    resultsArea.textContent = results.text;
                    processingResults = results.data;
                    
                    downloadBtn.disabled = false;
                    statusText.textContent = `Completed - ${results.data.highMatches.length} high matches, ${results.data.partialMatches.length} partial matches`;
                    
                    setTimeout(() => {
                        progressFill.style.width = '0%';
                        compareBtn.disabled = false;
                    }, 1000);
                }
            }, 100);
        }
        
        // Perform real matching
        function performRealMatching() {
            const threshold = parseInt(thresholdSlider.value);
            const highMatches = [];
            const partialMatches = [];
            const onlyInUNList = [];
            const onlyInFile = [];
            
            // Find name columns (try common column names)
            const unNameCol = findNameColumn(Object.keys(unListData[0] || {}));
            const fileNameCol = findNameColumn(Object.keys(fileData[0] || {}));
            
            if (!unNameCol || !fileNameCol) {
                return {
                    text: '‚ùå Error: Could not find name columns in the uploaded files. Please ensure your files have name columns.',
                    data: { highMatches: [], partialMatches: [], onlyInUNList: [], onlyInFile: [] }
                };
            }
            
            // Perform matching
            const unNames = new Set();
            const fileNames = new Set();
            
            // Collect all names
            unListData.forEach(row => {
                const name = String(row[unNameCol] || '').trim();
                if (name) {
                    unNames.add(name.toLowerCase());
                }
            });
            
            fileData.forEach(row => {
                const name = String(row[fileNameCol] || '').trim();
                if (name) {
                    fileNames.add(name.toLowerCase());
                }
            });
            
            // Find matches
            fileData.forEach(fileRow => {
                const fileName = String(fileRow[fileNameCol] || '').trim();
                if (!fileName) return;
                
                let bestMatch = null;
                let bestScore = 0;
                
                unListData.forEach(unRow => {
                    const unName = String(unRow[unNameCol] || '').trim();
                    if (!unName) return;
                    
                    const score = calculateSimilarity(fileName, unName);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = { unName, score, unRow };
                    }
                });
                
                if (bestMatch) {
                    if (bestScore >= threshold) {
                        highMatches.push({
                            fileName,
                            unName: bestMatch.unName,
                            score: bestScore.toFixed(1),
                            fileRow,
                            unRow: bestMatch.unRow
                        });
                    } else if (bestScore >= 50) {
                        partialMatches.push({
                            fileName,
                            unName: bestMatch.unName,
                            score: bestScore.toFixed(1),
                            fileRow,
                            unRow: bestMatch.unRow
                        });
                    }
                }
            });
            
            // Generate results text
            let resultsText = `üéØ High Matches (‚â•${threshold}%): ${highMatches.length}\n`;
            resultsText += `üîç Partial Matches (<${threshold}%): ${partialMatches.length}\n`;
            resultsText += `üìã Total UN_List records: ${unListData.length}\n`;
            resultsText += `üìã Total file records: ${fileData.length}\n\n`;
            resultsText += `============================================================\n`;
            resultsText += `‚úÖ Processing completed successfully!\n\n`;
            
            if (highMatches.length > 0) {
                resultsText += `ü§ù HIGH CONFIDENCE MATCHES:\n`;
                resultsText += `--------------------------------------------------\n`;
                highMatches.slice(0, 15).forEach((match, index) => {
                    resultsText += `${index + 1}. ${match.fileName} ‚Üî ${match.unName} (Score: ${match.score}%)\n`;
                });
                if (highMatches.length > 15) {
                    resultsText += `... and ${highMatches.length - 15} more high matches\n`;
                }
                resultsText += `\n`;
            }
            
            if (partialMatches.length > 0) {
                resultsText += `üîç PARTIAL MATCHES (Below ${threshold}% threshold):\n`;
                resultsText += `--------------------------------------------------\n`;
                partialMatches.slice(0, 8).forEach((match, index) => {
                    resultsText += `${index + 1}. ${match.fileName} ‚Üî ${match.unName} (Score: ${match.score}%)\n`;
                });
                if (partialMatches.length > 8) {
                    resultsText += `... and ${partialMatches.length - 8} more partial matches\n`;
                }
                resultsText += `\n`;
            }
            
            resultsText += `============================================================`;
            
            return {
                text: resultsText,
                data: { highMatches, partialMatches, onlyInUNList, onlyInFile }
            };
        }
        
        // Find name column
        function findNameColumn(columns) {
            const nameKeywords = ['name', 'full_name', 'fullname', 'person', 'client', 'customer', 'individual'];
            
            for (const keyword of nameKeywords) {
                for (const col of columns) {
                    if (col.toLowerCase().includes(keyword)) {
                        return col;
                    }
                }
            }
            
            // If no name column found, try first string column
            for (const col of columns) {
                if (col.toLowerCase().includes('text') || col.toLowerCase().includes('string')) {
                    return col;
                }
            }
            
            // Return first column as fallback
            return columns[0];
        }
        
        // Download results
        function downloadResults() {
            if (!processingResults) {
                alert('No results to download');
                return;
            }
            
            // Create CSV content
            let csvContent = "Type,File Name,UN List Name,Score (%)\n";
            
            processingResults.highMatches.forEach(match => {
                csvContent += `High Match,"${match.fileName}","${match.unName}",${match.score}\n`;
            });
            
            processingResults.partialMatches.forEach(match => {
                csvContent += `Partial Match,"${match.fileName}","${match.unName}",${match.score}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sanction_screening_results_' + new Date().toISOString().slice(0,10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
